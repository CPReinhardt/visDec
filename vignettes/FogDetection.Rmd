---
title: "Fog Detection"
author: "Martin"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Fog Detection}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


## Image application
```{r, fig.show='hold'}
library(ggplot2)
library(foreach)
library(itertools)
library(data.table)
library(visDec)
library(imager)
filenames <- list.files("../inst/extdata/Meetterrein/", pattern=".jpg", full.names=TRUE)
imageSummary <- lapply(filenames, ExtractBasicImageStatistics)
imageSummary <- rbindlist(imageSummary)
ggplot(imageSummary, aes(x = datetime, y = mean)) + geom_line()
ggplot(imageSummary, aes(x = datetime, y = var)) + geom_line()
ggplot(imageSummary, aes(x = datetime, y = sqrt(var)/mean)) + geom_line()
#ggplot(imageSummary[datetime > "2015-10-09" & datetime <= "2015-10-10"], aes(x = datetime, y = mean)) + geom_line()
```

```{r, fig.show='hold'}
sensorFiles <- list.files("../inst/extdata/Sensor",
                          pattern=glob2rx("MOR_DeBilt*.txt"),
                          full.names=TRUE)
sensor <- rbindlist(lapply(sensorFiles, fread))
sensor[FS261 == -1, FS261 := NA]
fn <- function(x) {
  if (x < 10000) paste("00", x, sep="")
  else if (x < 100000) paste("0", x, sep="")
  else if (x == 240000) paste("235959") #Fix naming
  else paste(x)
}
newTime <- sensor[, fn(hhmmss), by = .(yyyymmhh, hhmmss)]$V1
sensor[, hhmmss := newTime]
newDateTime <- as.POSIXct(sensor[, paste(yyyymmhh, hhmmss)], format="%Y%m%d %H%M%S")
sensor[, yyyymmhh := newDateTime]
setnames(sensor, "yyyymmhh", "dateTime")
sensor[, hhmmss := NULL]
sensor[, year := year(dateTime)]
sensor[, month := month(dateTime)]
sensor[, day := mday(dateTime)]
sensor[, hour := hour(dateTime)]

sensor[FS261 < 200, unique(day), by = month]
sensor[FS261 < 200 & month == 11 & day == 8, ]

PointAnalyser(filenames[60])
```

## Outlook
Is it promising to search for a horizontal window, with the maximum contrast and use this only this window to determine fog? In this way areas with only sky or grass could be neglected.

```{r, fig.show='hold'}
im <- load.image(filenames[1])
mean(im)
var(im)

filenames[1] %>% ExtractBasicImageStatistics()
```

